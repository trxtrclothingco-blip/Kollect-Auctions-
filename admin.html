<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin – Kollect Auctions</title>
<link rel="stylesheet" href="style.css">
<script type="module" src="firebase.js"></script>
<script type="module" src="admin.js"></script>
</head>
<body>

<div class="container">

  <!-- Password Screen -->
  <div id="password-screen" class="password-screen">
    <form id="password-form" class="password-form">
      <h2>Enter Admin Password</h2>
      <input type="password" id="admin-password" placeholder="Password" required>
      <button type="submit" class="button">Enter</button>
    </form>
  </div>

  <!-- Admin Panel -->
  <div id="admin-panel" style="display:none;">
    <img src="IMG_1604.jpeg" alt="Kollect Auctions Logo" class="hero-image">
    <h1>Admin Panel</h1>
    <p>Only authorized personnel can access and manage auction data here.</p>

    <!-- Bids -->
    <div class="card">
      <h3>View All Bids</h3>
      <div id="bids-list">
        <!-- Dynamically populated -->
      </div>
    </div>

    <!-- Add/Edit Item -->
    <div class="card">
      <h3>Add / Edit Item</h3>
      <form id="item-form">
        <input type="hidden" id="item_id" name="item_id">
        <input type="text" name="item_name" placeholder="Item Name" required>
        <textarea name="item_description" placeholder="Item Description"></textarea>
        <input type="number" name="item_price" placeholder="Price / Auction Start Price" required>
        
        <label>Price Type</label>
        <select name="price_type" required>
          <option value="fixed">Fixed Price</option>
          <option value="auction">Auction Start Price</option>
        </select>

        <label>Sale Type</label>
        <select name="sale_type" required>
          <option value="">Select Type</option>
          <option value="private_sales">Private Sale</option>
          <option value="live_auctions">Live Auction</option>
          <option value="kollect_100">Kollect 100</option>
        </select>

        <label>Upload Image</label>
        <input type="file" name="item_image" id="item_image" accept="image/*">

        <button type="submit" class="button">Add / Update Item</button>
      </form>
    </div>

    <!-- Manage Items -->
    <div class="card">
      <h3>Manage Items</h3>
      <div id="items-list">
        <!-- Dynamically populated -->
      </div>
    </div>

  </div>
</div>

<script type="module">
  import { auth, db } from "./firebase.js";
  import { collection, addDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  // Password check
  document.getElementById("password-form").addEventListener("submit", (e) => {
    e.preventDefault();
    if (document.getElementById("admin-password").value === "@PJL2025") {
      document.getElementById("password-screen").style.display = "none";
      document.getElementById("admin-panel").style.display = "block";
      loadItems();
      loadBids();
    } else {
      alert("Incorrect password");
    }
  });

  // Load items for management
  function loadItems() {
    const itemsList = document.getElementById("items-list");
    const collections = ["private_sales", "live_auctions", "kollect_100"];
    collections.forEach(colName => {
      const section = document.createElement("div");
      section.innerHTML = `<h4>${colName.replace("_", " ").toUpperCase()}</h4>`;
      itemsList.appendChild(section);
      const q = query(collection(db, colName), orderBy("createdAt", "desc"));
      onSnapshot(q, snapshot => {
        section.innerHTML = `<h4>${colName.replace("_", " ").toUpperCase()}</h4>`;
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          const itemEl = document.createElement("div");
          itemEl.innerHTML = `
            <p>${data.name} - £${data.price} (${data.priceType})</p>
            <button onclick="editItem('${docSnap.id}', '${colName}')">Edit</button>
            <button onclick="deleteItem('${docSnap.id}', '${colName}')">Delete</button>
          `;
          section.appendChild(itemEl);
        });
      });
    });
  }

  // Edit item
  window.editItem = async (id, col) => {
    const docRef = doc(db, col, id);
    const docSnap = await getDoc(docRef);
    if (docSnap.exists()) {
      const data = docSnap.data();
      document.querySelector('[name="item_name"]').value = data.name || "";
      document.querySelector('[name="item_description"]').value = data.description || "";
      document.querySelector('[name="item_price"]').value = data.price || "";
      document.querySelector('[name="price_type"]').value = data.priceType || "fixed";
      document.querySelector('[name="sale_type"]').value = col;
      document.getElementById("item_id").value = id;

      // Show current image preview
      let preview = document.getElementById("image-preview");
      if (!preview) {
        preview = document.createElement("img");
        preview.id = "image-preview";
        preview.style.maxWidth = "200px";
        preview.style.display = "block";
        preview.style.marginBottom = "10px";
        const itemForm = document.getElementById("item-form");
        itemForm.insertBefore(preview, itemForm.querySelector('[name="item_image"]'));
      }
      preview.src = data.image || "";
    }
  };

  // Delete item
  window.deleteItem = async (id, col) => {
    if (confirm("Are you sure you want to delete this item?")) {
      await deleteDoc(doc(db, col, id));
      alert("Item deleted");
    }
  };

  // Item form submit with Cloudinary upload
  const itemForm = document.getElementById("item-form");
  itemForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData(itemForm);
    const saleType = formData.get("sale_type");
    if (!saleType) return alert("Select sale type");

    const data = {
      name: formData.get("item_name"),
      description: formData.get("item_description"),
      price: Number(formData.get("item_price")),
      priceType: formData.get("price_type"),
      createdAt: new Date()
    };

    const file = formData.get("item_image");
    if (file && file.name) {
      const uploadForm = new FormData();
      uploadForm.append("file", file);
      uploadForm.append("upload_preset", "Profile_pictures"); // Using same as dashboard
      uploadForm.append("folder", "profilePics"); // Using same as dashboard, but ideally change to 'itemPics'

      const cloudName = "def0sfrxq";
      const url = `https://api.cloudinary.com/v1_1/${cloudName}/image/upload`;
      try {
        const res = await fetch(url, { method: "POST", body: uploadForm });
        const resData = await res.json();
        if (resData.secure_url) {
          data.image = resData.secure_url;
        } else {
          throw new Error("Upload failed");
        }
      } catch (err) {
        alert("Image upload failed: " + err.message);
        return;
      }
    }

    const itemId = formData.get("item_id");
    if (itemId) {
      const docRef = doc(db, saleType, itemId);
      await updateDoc(docRef, data);
    } else {
      const colRef = collection(db, saleType);
      await addDoc(colRef, data);
    }

    itemForm.reset();
    document.getElementById("item_id").value = "";
    const preview = document.getElementById("image-preview");
    if (preview) preview.remove();
    alert("Item saved!");
  });

  // Load bids with highest per item
  function loadBids() {
    const bidsList = document.getElementById("bids-list");
    let bidsData = {};
    const q = query(collection(db, "bids"), orderBy("bidAmount", "desc"));
    onSnapshot(q, snapshot => {
      snapshot.docChanges().forEach(change => {
        if (change.type === "added" || change.type === "modified") {
          bidsData[change.doc.id] = change.doc.data();
        } else if (change.type === "removed") {
          delete bidsData[change.doc.id];
        }
      });

      const itemsBids = {};
      for (let bid of Object.values(bidsData)) {
        const itemId = bid.itemId;
        if (!itemsBids[itemId] || bid.bidAmount > itemsBids[itemId].bidAmount) {
          itemsBids[itemId] = bid;
        }
      }

      bidsList.innerHTML = "";
      for (let highest of Object.values(itemsBids)) {
        const bidTime = highest.bidTime ? highest.bidTime.toDate().toLocaleString() : "Unknown";
        bidsList.innerHTML += `
          <p>Item: ${highest.itemName} - Highest Bid: £${highest.bidAmount} by ${highest.userEmail || "Unknown"} at ${bidTime}</p>
        `;
      }
      if (Object.keys(itemsBids).length === 0) {
        bidsList.innerHTML = "<p>No bids yet.</p>";
      }
    });
  }
</script>

</body>
</html>
