<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kollect 100</title>
<link rel="stylesheet" href="style.css">
<script type="module" src="firebase.js"></script>

<!-- Solana & Wallet Adapter -->
<script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.91.0/lib/index.iife.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@solana/wallet-adapter-base@0.10.9/lib/index.iife.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@solana/wallet-adapter-wallets@0.10.10/lib/index.iife.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@solana/wallet-adapter-react-ui@0.10.10/lib/index.iife.min.js"></script>

<style>
.bid-card {
  background:#2a2a2a;
  border:1px solid #FFD700;
  padding:10px;
  margin:10px;
  border-radius:6px;
  width: 300px;
  display: inline-block;
  vertical-align: top;
  text-align: center;
}
.bid-card img {
  display:block;
  margin:10px auto;
  width:100%;
  height:200px;
  object-fit:cover;
  border-radius:6px;
}
.button, .consign-btn {
  background-color: #FFD700;
  color: #1e1e1e;
  font-weight: bold;
  border-radius: 8px;
  border: 2px solid #1e1e1e;
  padding: 10px 20px;
  cursor:pointer;
  transition: all 0.3s ease;
  margin: 5px 0;
}
.button:hover, .consign-btn:hover {
  background-color:#fff;
  color:#FFD700;
  transform: scale(1.05);
}
</style>

</head>
<body>

<div class="burger" onclick="toggleMenu()">
  <div></div><div></div><div></div>
</div>

<nav class="nav-menu" id="navMenu">
  <a href="index.html">Home</a>
  <a href="dashboard.html">Dashboard</a>
  <a href="about.html">About Us</a>
  <a href="live_auctions.html">Live Auctions</a>
  <a href="kollect_100.html">Kollect 100</a>
  <a href="private_sales.html">Private Sales</a>
  <a href="contact.html">Contact Us</a>
  <a href="admin.html">Admin</a>
  <a href="results.html">Results</a>
  <a href="create_account.html">Sign In</a>
</nav>

<div id="user-status">Checking login status...</div>
<button id="logout-button" style="display:none;" onclick="logoutUser()">Logout</button>

<div class="container">
  <img src="IMG_1685.jpeg" alt="Kollect Auctions Logo" class="hero-image">
  <h1>Kollect 100 – High Ticket Exclusive Items</h1>

  <p>
    Welcome to Kollect 100! High-value items on this page can now be purchased using our native Kollect Coin ($KCT). 
    Paying in $KCT grants you a <strong>5% discount</strong> on the total auction price compared to standard fiat currency. 
    Connect your Phantom Wallet (desktop or mobile) to view your live $KCT balance and start bidding on premium collectibles seamlessly.
  </p>

  <div style="margin:15px 0;">
    <button id="connect-wallet-btn" class="button">Connect Wallet</button>
    <span id="ktc-balance" style="margin-left:10px; font-weight:bold;">Balance: 0 $KCT</span>
  </div>

  <div id="kollect-items">
    <p>Loading high-ticket items…</p>
  </div>

  <button class="button" onclick="window.location='index.html'">Back to Home</button>
</div>

<script>
function toggleMenu(){
  document.getElementById("navMenu").classList.toggle("open");
}
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import {
  getFirestore, collection, addDoc, serverTimestamp, onSnapshot,
  query, orderBy, where, doc, updateDoc, getDocs, limit
} from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { firebaseConfig } from "./firebase.js";

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const itemsContainer = document.getElementById("kollect-items");

// --- Countdown Timer with auto-end logic ---
function createCountdownTimer(item, endTime, displayEl, cardEl) {
  async function updateTimer() {
    const now = Date.now();
    const distance = endTime - now;

    if (distance <= 0) {
      displayEl.textContent = "Auction ended";
      clearInterval(timerInterval);

      try {
        const bidsQ = query(
          collection(db, "bids"),
          where("listingid:", "==", item.id),
          orderBy("bidamount:", "desc"),
          limit(1)
        );

        const bidSnap = await getDocs(bidsQ);

        let winnerid = null;
        let winneremail = null;
        let winningbid = null;

        if (!bidSnap.empty) {
          const topBid = bidSnap.docs[0].data();
          winnerid = topBid["userid:"];
          winneremail = topBid["useremail:"];
          winningbid = topBid["bidamount:"];
        }

        await updateDoc(doc(db, "kollect100", item.id), {
          "status:": "ended",
          "winnerid:": winnerid,
          "winneremail:": winneremail,
          "winningbid:": winningbid
        });

        cardEl.remove();
      } catch (e) {
        console.error("Failed to end auction:", e);
      }
      return;
    }

    const h = Math.floor(distance / 3600000);
    const m = Math.floor((distance % 3600000) / 60000);
    const s = Math.floor((distance % 60000) / 1000);
    displayEl.textContent = `Ends in ${h}h ${m}m ${s}s`;
  }

  updateTimer();
  const timerInterval = setInterval(updateTimer, 1000);
}

// --- Place Bid ---
async function placeBid(itemId, bidInput) {
  const bidAmount = parseFloat(bidInput.value);
  if (isNaN(bidAmount) || bidAmount <= 0) return alert("Enter a valid bid amount");

  try {
    await addDoc(collection(db, "bids"), {
      "listingid:": itemId,
      "bidamount:": bidAmount,
      "useremail:": "Anonymous",
      "userid:": "Anonymous",
      "timestamp:": serverTimestamp()
    });
    bidInput.value = "";
  } catch (e) {
    console.error(e);
    alert("Failed to place bid");
  }
}

// --- Load Kollect100 items live ---
function loadKollectItemsLive() {
  onSnapshot(collection(db, "kollect100"), snapshot => {
    itemsContainer.innerHTML = "";

    snapshot.forEach(docSnap => {
      const item = docSnap.data();
      item.id = docSnap.id;

      const card = document.createElement("div");
      card.className = "bid-card";
      card.innerHTML = `
        <h3>${item["name:"]}</h3>
        ${item["image:"] ? `<img src="${item["image:"]}">` : ""}
        <p>${item["description:"]}</p>
        <p>Current Price: £<span class="current-price">${item["price:"]?.toLocaleString() || "0"}</span></p>
        <p class="auction-timer">Loading timer...</p>
        <input type="number" placeholder="Enter bid amount" class="bid-input">
        <button class="consign-btn place-bid-btn">Place Bid</button>
      `;
      itemsContainer.appendChild(card);

      if (item["auctionend:"]) {
        createCountdownTimer(
          item,
          item["auctionend:"].toDate(),
          card.querySelector(".auction-timer"),
          card
        );
      }

      const priceEl = card.querySelector(".current-price");
      const bidsQuery = query(
        collection(db, "bids"),
        where("listingid:", "==", item.id),
        orderBy("bidamount:", "desc")
      );

      onSnapshot(bidsQuery, bidSnap => {
        if (!bidSnap.empty) {
          priceEl.textContent = bidSnap.docs[0].data()["bidamount:"].toLocaleString();
        }
      });

      card.querySelector(".place-bid-btn")
        .addEventListener("click", () =>
          placeBid(item.id, card.querySelector(".bid-input"))
        );
    });
  });
}

loadKollectItemsLive();
</script>

</body>
</html>
