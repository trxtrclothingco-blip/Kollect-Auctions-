<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Create Account – Kollect Auctions</title>
<link rel="stylesheet" href="style.css">
<script type="module" src="firebase.js"></script>
<style>
/* Popup message styling */
.popup-message {
  position: fixed;
  top: 20px;
  right: 20px;
  background-color: #4caf50;
  color: white;
  padding: 12px 20px;
  border-radius: 5px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  z-index: 1000;
  font-family: inherit;
  font-size: 14px;
  opacity: 0;
  transition: opacity 0.3s ease-in-out;
}
.popup-message.show {
  opacity: 1;
}
</style>
</head>
<body>

<!-- Burger Menu -->
<div class="burger" onclick="toggleMenu()">
  <div></div><div></div><div></div>
</div>

<nav class="nav-menu" id="navMenu">
  <a href="index.html">Home</a>
  <a href="about.html">About Us</a>
  <a href="live_auctions.html">Live Auctions</a>
  <a href="kollect_100.html">Watchlist ⭐️</a>
  <a href="private_sales.html">Private Sales</a>
  <a href="contact.html">Contact Us</a>
  <a href="results.html">Results</a>
  <a href="create_account.html">Sign In</a>
</nav>

<!-- User Status -->
<div id="user-status">Checking login status...</div>
<button id="logout-button" style="display:none;" onclick="logoutUser()">Logout</button>

<div class="container">
  <img src="IMG_1729.jpeg" alt="Kollect Auctions Logo" class="hero-image">

  <!-- Login Form -->
  <div class="card">
    <h2>Sign In</h2>
    <form id="login-form">
      <input type="email" id="login-email" placeholder="Email" required>
      <input type="password" id="login-password" placeholder="Password" required>
      <button type="button" id="login-button" class="button">Sign In</button>
    </form>
  </div>

  <!-- Sign Up Form -->
  <div class="card">
    <h2>Create Account</h2>
    <form id="signup-form">
      <input type="text" id="signup-firstname" placeholder="First Name" required>
      <input type="text" id="signup-lastname" placeholder="Last Name" required>
      <input type="email" id="signup-email" placeholder="Email" required>
      <input type="password" id="signup-password" placeholder="Password" required>
      <input type="password" id="signup-confirm-password" placeholder="Confirm Password" required>
      <input type="tel" id="signup-contact" placeholder="Contact Number" required>
      <input type="text" id="signup-address1" placeholder="Address Line 1" required>
      <input type="text" id="signup-address2" placeholder="Address Line 2">
      <input type="text" id="signup-city" placeholder="City" required>
      <input type="text" id="signup-postcode" placeholder="Postcode" required>
      <button type="submit" class="button">Create Account</button>
    </form>
  </div>
</div>

<script type="module">
import { auth, db } from "./firebase.js";
import { createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

// ---------- DOM ----------
const loginForm = document.getElementById("login-form");
const loginButton = document.getElementById("login-button");
const signupForm = document.getElementById("signup-form");
const userStatus = document.getElementById("user-status");
const logoutButton = document.getElementById("logout-button");

// ---------- Burger Menu ----------
window.toggleMenu = () => document.getElementById("navMenu")?.classList.toggle("open");

// ---------- Light/Dark Mode ----------
const body = document.body;
if(localStorage.getItem("lightMode")==="true") body.classList.add("light-mode");
window.toggleMode = () => {
  const isLight = body.classList.toggle("light-mode");
  localStorage.setItem("lightMode", isLight);
};

// ---------- Logout ----------
window.logoutUser = async () => {
  try { 
    await signOut(auth);
    window.location.reload();
  } catch(e) { console.error(e); }
};

// ---------- Auth State ----------
onAuthStateChanged(auth, user => {
  if(user){
    userStatus.textContent = `Logged in as ${user.email}`;
    logoutButton.style.display = "inline-block";
  } else {
    userStatus.textContent = "Not logged in";
    logoutButton.style.display = "none";
  }
});

// ---------- Show Popup ----------
function showPopupMessage(message){
  const popup = document.createElement("div");
  popup.className = "popup-message";
  popup.textContent = message;
  document.body.appendChild(popup);
  setTimeout(()=>popup.classList.add("show"), 10);
  setTimeout(()=>popup.remove(), 3000);
}

// ---------- Login ----------
loginButton?.addEventListener("click", async () => {
  const email = document.getElementById("login-email").value;
  const password = document.getElementById("login-password").value;
  try {
    await signInWithEmailAndPassword(auth, email, password);
    showPopupMessage("Login successful!");
    loginForm.reset();
    window.location.href = "index.html"; // redirect after login
  } catch (err) {
    alert("Login failed: " + err.message);
  }
});

// ---------- Signup ----------
signupForm?.addEventListener("submit", async e => {
  e.preventDefault();
  const firstName = document.getElementById("signup-firstname").value.trim();
  const lastName = document.getElementById("signup-lastname").value.trim();
  const email = document.getElementById("signup-email").value.trim();
  const password = document.getElementById("signup-password").value;
  const confirmPassword = document.getElementById("signup-confirm-password").value;
  const contact = document.getElementById("signup-contact").value.trim();
  const address1 = document.getElementById("signup-address1").value.trim();
  const address2 = document.getElementById("signup-address2").value.trim();
  const city = document.getElementById("signup-city").value.trim();
  const postcode = document.getElementById("signup-postcode").value.trim();

  if(password !== confirmPassword){
    return alert("Passwords do not match!");
  }

  try {
    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
    const user = userCredential.user;
    await updateProfile(user, { displayName: firstName + " " + lastName });

    // ✅ Save additional user info in Firestore using uid as doc ID
    await setDoc(doc(db, "users", user.uid), {
      uid: user.uid,
      firstName,
      lastName,
      email,
      contact,
      address1,
      address2,
      city,
      postcode,
      profilepicurl: "",
      createdAt: serverTimestamp()
    });

    showPopupMessage("Account created successfully!");
    signupForm.reset();
    setTimeout(() => window.location.href = "dashboard.html", 1500); // auto redirect
  } catch (err) {
    alert("Signup failed: " + err.message);
  }
});
</script>
</body>
</html>
