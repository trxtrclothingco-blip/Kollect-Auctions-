<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Kollect Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="style.css">

<style>
.chat-card { max-width: 800px; }

/* Top bar */
#activeUserCountContainer {
  display: flex;
  align-items: center;
  gap: 16px;
  margin-bottom: 12px;
}

/* ONLINE box */
#activeUserCount {
  padding: 8px 16px;
  font-weight: 900;
  font-size: 18px;
  color: #00ff66;
  border: 2px solid #00ff66;
  border-radius: 10px;
  background: rgba(0, 255, 100, 0.08);
  box-shadow:
    0 0 8px rgba(0,255,100,0.8),
    0 0 16px rgba(0,255,100,0.6),
    inset 0 0 6px rgba(0,255,100,0.4);
}

/* Dashboard button (gold) */
#dashboardButton {
  padding: 8px 16px;
  font-weight: 700;
  color: #1a1200;
  background: linear-gradient(135deg, #ffd700, #ffb700);
  border: none;
  border-radius: 8px;
  cursor: pointer;
  box-shadow:
    0 0 6px rgba(255,215,0,0.6),
    0 4px 10px rgba(0,0,0,0.3);
  transition: all 0.2s ease;
}

#dashboardButton:hover {
  transform: translateY(-1px);
  box-shadow:
    0 0 12px rgba(255,215,0,0.9),
    0 6px 14px rgba(0,0,0,0.4);
}

/* Chat */
#chatWindow {
  height: 420px;
  overflow-y: auto;
  padding: 15px;
  margin-bottom: 15px;
  border-radius: 12px;
  background: rgba(0,0,0,0.35);
}
body.light-mode #chatWindow { background: rgba(240,240,240,0.8); }

.chat-message { display: flex; align-items: flex-start; margin-bottom: 14px; }

.chat-bubble {
  background: rgba(255,255,255,0.06);
  padding: 10px 14px;
  border-radius: 12px;
  text-align: left;
  width: 100%;
}
body.light-mode .chat-bubble { background: rgba(255,255,255,0.9); }

.chat-username {
  font-size: 12px;
  font-weight: 600;
  opacity: 0.75;
  margin-bottom: 4px;
}

.chat-timestamp {
  font-size: 10px;
  opacity: 0.6;
  margin-top: 2px;
}

.chat-reply {
  font-size: 11px;
  color: #ccc;
  margin-bottom: 2px;
  padding-left: 10px;
  border-left: 2px solid #888;
  cursor: pointer;
}

.chat-input { display: flex; gap: 10px; }
.chat-input input { flex: 1; }

#pinnedInput {
  width: 100%;
  padding: 6px;
  margin-bottom: 8px;
  border-radius: 6px;
  border: 1px solid #aaa;
  display: none;
}
</style>
</head>

<body>

<div class="container">
  <h1>Kollect Chat</h1>
  <p>Live community discussion for collectors</p>

  <div id="activeUserCountContainer">
    <div id="activeUserCount">Online</div>
    <button id="dashboardButton" onclick="location.href='dashboard.html'">Dashboard</button>
  </div>

  <div class="card chat-card">
    <input id="pinnedInput" placeholder="Pin a message…">
    <div id="chatWindow"></div>

    <div class="chat-input">
      <input id="messageInput" type="text" placeholder="Log in to post messages…" disabled>
      <button class="button" id="sendButton" disabled>Send</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-analytics.js";
import { getFirestore, collection, doc, getDoc, setDoc, addDoc, query, orderBy, onSnapshot, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyCGfejcFwdLTKow_yPptWfbdyrcc2b6dNc",
  authDomain: "kollectauctions-b9de9.firebaseapp.com",
  projectId: "kollectauctions-b9de9",
  storageBucket: "kollectauctions-b9de9.firebasestorage.app",
  messagingSenderId: "185844480439",
  appId: "1:185844480439:web:36de485ff58fcca2cc5032",
  measurementId: "G-DJ0NLNG2LN"
};

const app = initializeApp(firebaseConfig);
getAnalytics(app);
const db = getFirestore(app);
const auth = getAuth(app);

const chatWindow = document.getElementById("chatWindow");
const input = document.getElementById("messageInput");
const sendButton = document.getElementById("sendButton");
const pinnedInput = document.getElementById("pinnedInput");

const messagesCol = collection(db, "kollectchat");
const messagesQuery = query(messagesCol, orderBy("timestamp", "asc"));
const usersCol = collection(db, "users");
const activeUsersCol = collection(db, "kollectchatActiveUsers");

let userFirstName = "anonymous";
let userProfilePic = "";
let currentUserUid = "";
let replyToMessage = null;

const adminUid = "gBrbEobcS5RCG47acE5ySqxO8yB2";

onAuthStateChanged(auth, async user => {
  if (user) {
    currentUserUid = user.uid;
    const snap = await getDoc(doc(usersCol, user.uid));
    if (snap.exists()) {
      userFirstName = snap.data().firstName || "anonymous";
      userProfilePic = snap.data().profilepicurl || "";
    }

    input.disabled = false;
    sendButton.disabled = false;
    input.placeholder = "Type a message…";

    if (currentUserUid === adminUid) pinnedInput.style.display = "block";

    await setDoc(doc(activeUsersCol, currentUserUid), {
      username: userFirstName,
      lastActive: serverTimestamp()
    });

    window.addEventListener("beforeunload", async () => {
      await deleteDoc(doc(activeUsersCol, currentUserUid));
    });
  } else {
    input.disabled = true;
    sendButton.disabled = true;
    pinnedInput.style.display = "none";
  }
});

onSnapshot(messagesQuery, snapshot => {
  chatWindow.innerHTML = "";
  snapshot.forEach(docSnap => {
    const data = docSnap.data();

    const message = document.createElement("div");
    message.className = "chat-message";

    const bubble = document.createElement("div");
    bubble.className = "chat-bubble";

    bubble.innerHTML = `
      <div class="chat-username">${data.username || "anonymous"}</div>
      <div>${data.text || ""}</div>
      <div class="chat-timestamp">${data.timestamp?.toDate?.().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) || ""}</div>
    `;

    message.appendChild(bubble);
    chatWindow.appendChild(message);
  });

  chatWindow.scrollTop = chatWindow.scrollHeight;
});

async function sendMessage() {
  if (!auth.currentUser || !input.value.trim()) return;

  await addDoc(messagesCol, {
    username: userFirstName,
    uid: currentUserUid,
    profilepicurl: userProfilePic,
    text: input.value.trim(),
    timestamp: serverTimestamp()
  });

  input.value = "";
  replyToMessage = null;
}

sendButton.addEventListener("click", sendMessage);
input.addEventListener("keydown", e => { if (e.key === "Enter") sendMessage(); });
</script>

</body>
</html>
