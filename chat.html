<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Kollect Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="style.css">

<style>
.chat-card { max-width: 800px; }

/* Top bar */
#activeUserCountContainer {
  display: flex;
  align-items: center;
  gap: 16px;
  margin-bottom: 12px;
}

/* ONLINE box */
#activeUserCount {
  padding: 8px 16px;
  font-weight: 900;
  font-size: 18px;
  color: #00ff66;
  border: 2px solid #00ff66;
  border-radius: 10px;
  background: rgba(0, 255, 100, 0.08);
  box-shadow:
    0 0 8px rgba(0,255,100,0.8),
    0 0 16px rgba(0,255,100,0.6),
    inset 0 0 6px rgba(0,255,100,0.4);
}

/* Dashboard button */
#dashboardButton {
  padding: 8px 16px;
  font-weight: 700;
  color: #1a1200;
  background: linear-gradient(135deg, #ffd700, #ffb700);
  border: none;
  border-radius: 8px;
  cursor: pointer;
}

/* Chat */
#chatWindow {
  height: 420px;
  overflow-y: auto;
  padding: 15px;
  margin-bottom: 15px;
  border-radius: 12px;
  background: rgba(0,0,0,0.35);
}

.chat-message { margin-bottom: 14px; }

.chat-bubble {
  background: rgba(255,255,255,0.06);
  padding: 10px 14px;
  border-radius: 12px;
}

.chat-username {
  font-size: 12px;
  font-weight: 600;
  opacity: 0.75;
}

.chat-timestamp {
  font-size: 10px;
  opacity: 0.6;
}

.chat-reply-preview {
  font-size: 11px;
  color: #ccc;
  padding-left: 10px;
  margin-bottom: 4px;
  border-left: 2px solid #888;
}

.reply-action {
  font-size: 11px;
  opacity: 0.6;
  cursor: pointer;
  margin-top: 4px;
}

#replyIndicator {
  display: none;
  font-size: 12px;
  padding: 6px;
  margin-bottom: 6px;
  border-left: 3px solid gold;
  background: rgba(255,215,0,0.1);
}

.chat-input { display: flex; gap: 10px; }
.chat-input input { flex: 1; }
</style>
</head>

<body>

<div class="container">
  <h1>Kollect Chat</h1>

  <div id="activeUserCountContainer">
    <div id="activeUserCount">Online</div>
    <button id="dashboardButton" onclick="location.href='dashboard.html'">Dashboard</button>
  </div>

  <div class="card chat-card">
    <div id="replyIndicator"></div>
    <div id="chatWindow"></div>

    <div class="chat-input">
      <input id="messageInput" type="text" placeholder="Log in to post messages…" disabled>
      <button class="button" id="sendButton" disabled>Send</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

const app = initializeApp({
  apiKey: "AIzaSyCGfejcFwdLTKow_yPptWfbdyrcc2b6dNc",
  authDomain: "kollectauctions-b9de9.firebaseapp.com",
  projectId: "kollectauctions-b9de9"
});

const db = getFirestore(app);
const auth = getAuth(app);

const chatWindow = document.getElementById("chatWindow");
const input = document.getElementById("messageInput");
const sendButton = document.getElementById("sendButton");
const replyIndicator = document.getElementById("replyIndicator");

const messagesCol = collection(db, "kollectchat");
const messagesQuery = query(messagesCol, orderBy("timestamp", "asc"));

let currentUser = null;
let replyTo = null;

onAuthStateChanged(auth, user => {
  if (user) {
    currentUser = user;
    input.disabled = false;
    sendButton.disabled = false;
  }
});

onSnapshot(messagesQuery, snapshot => {
  chatWindow.innerHTML = "";
  snapshot.forEach(docSnap => {
    const data = docSnap.data();

    const msg = document.createElement("div");
    msg.className = "chat-message";

    const bubble = document.createElement("div");
    bubble.className = "chat-bubble";

    if (data.replyTo) {
      bubble.innerHTML += `
        <div class="chat-reply-preview">
          Replying to <b>${data.replyTo.username}</b>: ${data.replyTo.text}
        </div>
      `;
    }

    bubble.innerHTML += `
      <div class="chat-username">${data.username}</div>
      <div>${data.text}</div>
      <div class="chat-timestamp">${data.timestamp?.toDate?.().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) || ""}</div>
      <div class="reply-action">↩ Reply</div>
    `;

    bubble.querySelector(".reply-action").onclick = () => {
      replyTo = {
        messageId: docSnap.id,
        username: data.username,
        text: data.text.split("\n")[0].slice(0, 80)
      };
      replyIndicator.style.display = "block";
      replyIndicator.textContent = `Replying to ${replyTo.username}: ${replyTo.text}`;
    };

    msg.appendChild(bubble);
    chatWindow.appendChild(msg);
  });

  chatWindow.scrollTop = chatWindow.scrollHeight;
});

async function sendMessage() {
  if (!input.value.trim()) return;

  await addDoc(messagesCol, {
    username: auth.currentUser.email || "anonymous",
    text: input.value.trim(),
    timestamp: serverTimestamp(),
    replyTo: replyTo || null
  });

  input.value = "";
  replyTo = null;
  replyIndicator.style.display = "none";
}

sendButton.onclick = sendMessage;
input.onkeydown = e => { if (e.key === "Enter") sendMessage(); };
</script>

</body>
</html>
