<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Live Auctions</title>
<link rel="stylesheet" href="style.css">
<script type="module" src="firebase.js"></script>
<script type="module" src="script.js"></script>
<script type="module" src="products.js"></script>
</head>
<body data-page="liveauctions">

<!-- Burger Menu -->
<div class="burger" onclick="toggleMenu()">
  <div></div><div></div><div></div>
</div>

<nav class="nav-menu" id="navMenu">
  <a href="index.html">Home</a>
  <a href="dashboard.html">Dashboard</a>
  <a href="about.html">About Us</a>
  <a href="live_auctions.html">Live Auctions</a>
  <a href="kollect_100.html">Kollect 100</a>
  <a href="private_sales.html">Private Sales</a>
  <a href="contact.html">Contact Us</a>
  <a href="admin.html">Admin</a>
  <a href="results.html">Results</a>
  <a href="create_account.html">Sign In</a>
  <button id="modeToggle" onclick="toggleMode()">Toggle Light/Dark Mode</button>
</nav>

<!-- User Status & Logout -->
<div id="user-status">Checking login status...</div>
<button id="logout-button" style="display:none;" onclick="logoutUser()">Logout</button>

<!-- Main Container -->
<div class="container">
  <img src="IMG_1604.jpeg" alt="Kollect Auctions Logo" class="hero-image">
  <h1 class="live-auctions-title">Live Auctions</h1>

  <!-- Container for dynamic items -->
  <div id="live-auctions-list"></div>
</div>

<script type="module">
import { db, auth } from './firebase.js';
import { collection, getDocs, query, orderBy, doc, updateDoc, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';
import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';

let currentUser = null;

// Track logged-in user
onAuthStateChanged(auth, (user) => {
  currentUser = user;
});

async function placeBid(listingId, currentPrice) {
  if (!currentUser) {
    alert('You must be signed in to place a bid.');
    return;
  }

  const bidAmountStr = prompt(`Enter your bid (current price £${Number(currentPrice).toLocaleString()}):`);
  const bidAmount = parseFloat(bidAmountStr);

  if (isNaN(bidAmount) || bidAmount <= currentPrice) {
    alert('Invalid bid. Must be a number higher than current price.');
    return;
  }

  try {
    // Add bid to 'bids' collection
    await addDoc(collection(db, 'bids'), {
      listingid: listingId,
      bidamount: bidAmount,
      timestamp: serverTimestamp(),
      userid: currentUser.uid
    });

    // Update listing price
    const listingRef = doc(db, 'listings', listingId);
    await updateDoc(listingRef, { price: bidAmount });

    alert('Bid placed successfully!');
  } catch (error) {
    console.error('Error placing bid:', error);
    alert('Failed to place bid. Please try again.');
  }
}

async function loadLiveAuctions() {
  const liveAuctionsList = document.getElementById('live-auctions-list');
  liveAuctionsList.innerHTML = ''; // Clear existing content

  try {
    const listingsQuery = query(collection(db, 'listings'), orderBy('createdAt', 'desc'));
    const querySnapshot = await getDocs(listingsQuery);

    if (querySnapshot.empty) {
      liveAuctionsList.innerHTML = '<p>No live auctions available.</p>';
      return;
    }

    querySnapshot.forEach((docSnap) => {
      const data = docSnap.data();
      const { name, description, price, image } = data;

      const card = document.createElement('div');
      card.classList.add('card', 'auction-card');

      card.innerHTML = `
        <img src="${image}" alt="${name}">
        <h3>${name}</h3>
        <p>${description || ''}</p>
        <p>Price: £${price ? Number(price).toLocaleString() : 'N/A'}</p>
        <button class="button">Bid Now</button>
      `;

      // Attach click handler for bidding
      card.querySelector('.button').addEventListener('click', () => placeBid(docSnap.id, price || 0));

      liveAuctionsList.appendChild(card);
    });

  } catch (error) {
    console.error('Error loading live auctions:', error);
    liveAuctionsList.innerHTML = '<p>Error loading items. Please try again later.</p>';
  }
}

document.addEventListener('DOMContentLoaded', loadLiveAuctions);
</script>

<style>
/* Modern bold heading for Live Auctions */
.live-auctions-title {
  font-family: "Arial Black", sans-serif;
  font-size: 3rem;
  font-weight: 900;
  color: #FFD700;
  text-align: center;
  margin: 30px 0;
}

/* Responsive for smaller screens */
@media (max-width: 768px){
  .live-auctions-title {
    font-size: 2.2rem;
    margin: 20px 0;
  }
}

/* Auction Cards */
.auction-card {
  background: #2a2a2a;
  border: 2px solid #FFD700;
  border-radius: 8px;
  padding: 10px;
  max-width: 300px;
  margin: 15px;
  display: inline-block;
  vertical-align: top;
  text-align: center;
}

.auction-card img {
  width: 100%;
  height: 200px;
  object-fit: cover;
  border-radius: 6px;
}

.auction-card h3 {
  margin: 10px 0 5px;
  color: #FFD700;
}

.auction-card p {
  margin: 5px 0;
}

.auction-card .button {
  background: #FFD700;
  border: none;
  border-radius: 6px;
  padding: 8px 12px;
  margin-top: 10px;
  cursor: pointer;
  font-weight: bold;
}

.auction-card .button:hover {
  background: #fff;
  color: #FFD700;
}

/* Responsive container */
.container {
  text-align: center;
}

@media (max-width: 768px){
  .auction-card {
    max-width: 90%;
    margin: 10px auto;
  }
}
</style>

</body>
</html>
