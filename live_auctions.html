<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Live Auctions</title>
<link rel="stylesheet" href="style.css">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { firebaseConfig } from "./firebase.js";

// ---------- Firebase Init ----------
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// ---------- DOM Elements ----------
const userStatus = document.getElementById("user-status");
const logoutButton = document.getElementById("logout-button");
const body = document.body;
const container = document.querySelector(".container");

// ---------- Burger Menu & Mode ----------
window.toggleMenu = () => document.getElementById("navMenu")?.classList.toggle("open");
if(localStorage.getItem("lightMode")==="true") body.classList.add("light-mode");
window.toggleMode = () => {
  const isLight = body.classList.toggle("light-mode");
  localStorage.setItem("lightMode", isLight);
};

// ---------- Logout ----------
window.logoutUser = async () => {
  try { 
    await signOut(auth); 
    window.location.href = "create_account.html";
  } catch(e) { console.error("Logout failed:", e); }
};

// ---------- Auth Status ----------
onAuthStateChanged(auth, (user) => {
  if(user){
    userStatus.textContent = `Logged in as ${user.email}`;
    logoutButton.style.display = "inline-block";
  } else {
    userStatus.textContent = `Not signed in`;
    logoutButton.style.display = "none";
  }
});

// ---------- Load Live Listings ----------
const listingsRef = collection(db, "listings");
const listingsQuery = query(listingsRef, orderBy("createdAt","desc"));

onSnapshot(listingsQuery, (snapshot) => {
  // Remove previous cards
  const oldCards = container.querySelectorAll(".auction-card");
  oldCards.forEach(c => c.remove());

  if(snapshot.empty){
    container.innerHTML += `<p>No live auctions available.</p>`;
    return;
  }

  snapshot.forEach(doc => {
    const item = doc.data();

    // Create card
    const card = document.createElement("div");
    card.className = "card auction-card";

    // Image
    const img = document.createElement("img");
    img.src = item["image:"] || "default-image.png";
    img.alt = item.item_name || "Auction Item";

    // Title
    const title = document.createElement("h3");
    title.textContent = item.item_name || "Unnamed Item";

    // Description
    const desc = document.createElement("p");
    desc.textContent = item.item_description || "";

    // Price
    const price = document.createElement("p");
    price.textContent = item.starting_price ? `Starting at Â£${Number(item.starting_price).toLocaleString()}` : "Price N/A";

    // Button
    const button = document.createElement("button");
    button.className = "button";
    button.textContent = "View Auction";
    button.onclick = () => window.location = `item.html?id=${doc.id}`;

    // Append
    card.appendChild(img);
    card.appendChild(title);
    card.appendChild(desc);
    card.appendChild(price);
    card.appendChild(button);

    container.appendChild(card);
  });
});
</script>

</head>
<body>

<!-- Burger Menu -->
<div class="burger" onclick="toggleMenu()">
  <div></div><div></div><div></div>
</div>

<!-- Navigation -->
<nav class="nav-menu" id="navMenu">
  <a href="index.html">Home</a>
  <a href="dashboard.html">Dashboard</a>
  <a href="about.html">About Us</a>
  <a href="live_auctions.html">Live Auctions</a>
  <a href="kollect_100.html">Kollect 100</a>
  <a href="private_sales.html">Private Sales</a>
  <a href="contact.html">Contact Us</a>
  <a href="admin.html">Admin</a>
  <a href="results.html">Results</a>
  <a href="create_account.html">Sign In</a>
  <button id="modeToggle" onclick="toggleMode()">Toggle Light/Dark Mode</button>
</nav>

<!-- User Status & Logout -->
<div id="user-status">Checking login status...</div>
<button id="logout-button" style="display:none;" onclick="logoutUser()">Logout</button>

<!-- Main Container -->
<div class="container">
  <img src="IMG_1604.jpeg" alt="Kollect Auctions Logo" class="hero-image">
  <a href="private_sales.html" class="button">Private Sales</a>

  <div class="search-bar">
    <input type="text" placeholder="Search items..." id="searchInput">
    <select id="categorySelect">
      <option value="">All Categories</option>
      <option value="tgc-graded">TGC's Graded</option>
      <option value="tgc-raw">TGC's Raw</option>
      <option value="movies-books">Movies & Books</option>
      <option value="figures">Figures</option>
      <option value="lego">LEGO</option>
      <option value="video-games">Video Games</option>
      <option value="memorabilia">Memorabilia</option>
      <option value="comics">Comics</option>
      <option value="historical">Historical Items</option>
    </select>
    <select id="typeSelect">
      <option value="">All Types</option>
      <option value="auction">Auction</option>
      <option value="private">Private Sale</option>
    </select>
    <button class="button" id="searchBtn">Search</button>
  </div>
</div>

</body>
</html>
