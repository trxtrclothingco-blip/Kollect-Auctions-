<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard â€“ Kollect Auctions</title>
<link rel="stylesheet" href="style.css">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, doc, onSnapshot, updateDoc, collection, query, where, orderBy, getDoc, addDoc, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { firebaseConfig } from "./firebase.js";

// ---------- Firebase Initialization ----------
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ---------- DOM Elements ----------
const userStatus = document.getElementById("user-status");
const logoutButton = document.getElementById("logout-button");
const body = document.body;
const editBtn = document.getElementById("edit-btn");
const saveBtn = document.getElementById("save-btn");
const profilePicEl = document.getElementById("profile-pic");
const profileUpload = document.getElementById("profile-upload");
const liveBidsContainer = document.getElementById("live-bids-container");
const wonBidsContainer = document.getElementById("won-bids-container");
const salesContainer = document.getElementById("purchase-history-container");
const welcomeName = document.getElementById("welcome-name");

// Updated input IDs
const fields = ["first-name-input","last-name-input","email-input","contact-input","address1-input","address2-input","city-input","postcode-input"];
const inputs = fields.map(f => document.getElementById(f));

// ---------- Notifications State (persistent) ----------
const notificationState = {
  auctionEndingSoon: JSON.parse(localStorage.getItem("notification_auctionEndingSoon") || "{}"),
  outbid: JSON.parse(localStorage.getItem("notification_outbid") || "{}"),
  auctionWon: JSON.parse(localStorage.getItem("notification_auctionWon") || "{}")
};

function saveNotificationState() {
  localStorage.setItem("notification_auctionEndingSoon", JSON.stringify(notificationState.auctionEndingSoon));
  localStorage.setItem("notification_outbid", JSON.stringify(notificationState.outbid));
  localStorage.setItem("notification_auctionWon", JSON.stringify(notificationState.auctionWon));
}

// ---------- Notification Dropdown ----------
const notifBell = document.createElement("div");
notifBell.id = "notif-bell";
notifBell.innerHTML = "ðŸ”” <span id='notif-count'>0</span>";
notifBell.style.position = "fixed";
notifBell.style.top = "20px";
notifBell.style.right = "60px";
notifBell.style.cursor = "pointer";
notifBell.style.fontSize = "24px";
notifBell.style.zIndex = "10000";

const notifDropdown = document.createElement("div");
notifDropdown.id = "notif-dropdown";
notifDropdown.style.position = "fixed";
notifDropdown.style.top = "60px";
notifDropdown.style.right = "60px";
notifDropdown.style.width = "300px";
notifDropdown.style.maxHeight = "400px";
notifDropdown.style.overflowY = "auto";
notifDropdown.style.backgroundColor = "#1e1e1e";
notifDropdown.style.color = "#FFD700";
notifDropdown.style.border = "2px solid #FFD700";
notifDropdown.style.borderRadius = "8px";
notifDropdown.style.display = "none";
notifDropdown.style.zIndex = "10000";
document.body.appendChild(notifBell);
document.body.appendChild(notifDropdown);

notifBell.onclick = () => { notifDropdown.style.display = notifDropdown.style.display==="none"?"block":"none"; };

function updateNotifDropdown() {
  notifDropdown.innerHTML = "";
  const allNotifs = [
    ...Object.keys(notificationState.auctionEndingSoon).map(id => ({type:"Ending Soon", text: `Auction for "${notificationState.auctionEndingSoon[id].name}" ends in 5 minutes`, id})),
    ...Object.keys(notificationState.outbid).map(id => ({type:"Outbid", text: `You've been outbid on "${notificationState.outbid[id].name}"!`, id})),
    ...Object.keys(notificationState.auctionWon).map(id => ({type:"Won", text: `You won the auction for "${notificationState.auctionWon[id].name}"!`, id}))
  ];
  allNotifs.forEach(n => {
    const notifEl = document.createElement("div");
    notifEl.style.padding = "10px";
    notifEl.style.borderBottom = "1px solid #FFD700";
    notifEl.style.position = "relative";
    notifEl.textContent = n.text;

    const removeBtn = document.createElement("span");
    removeBtn.textContent = "âœ–";
    removeBtn.style.position = "absolute";
    removeBtn.style.top = "5px";
    removeBtn.style.right = "10px";
    removeBtn.style.cursor = "pointer";
    removeBtn.onclick = () => {
      if(n.type==="Ending Soon") delete notificationState.auctionEndingSoon[n.id];
      if(n.type==="Outbid") delete notificationState.outbid[n.id];
      if(n.type==="Won") delete notificationState.auctionWon[n.id];
      saveNotificationState();
      updateNotifDropdown();
      updateNotifCount();
    };
    notifEl.appendChild(removeBtn);
    notifDropdown.appendChild(notifEl);
  });
}

function updateNotifCount() {
  const count = Object.keys(notificationState.auctionEndingSoon).length + Object.keys(notificationState.outbid).length + Object.keys(notificationState.auctionWon).length;
  document.getElementById("notif-count").textContent = count;
}

function addNotification(type, id, name){
  if(type==="Ending Soon") notificationState.auctionEndingSoon[id] = {name};
  if(type==="Outbid") notificationState.outbid[id] = {name};
  if(type==="Won") notificationState.auctionWon[id] = {name};
  saveNotificationState();
  updateNotifDropdown();
  updateNotifCount();
}

// ---------- Burger Menu & Light/Dark Mode ----------
window.toggleMenu = () => document.getElementById("navMenu")?.classList.toggle("open");
if(localStorage.getItem("lightMode")==="true") body.classList.add("light-mode");
window.toggleMode = () => {
  const isLight = body.classList.toggle("light-mode");
  localStorage.setItem("lightMode", isLight);
};

// ---------- Logout ----------
window.logoutUser = async () => {
  try { 
    await signOut(auth); 
    window.location.href = "create_account.html";
  } catch(e) { console.error("Logout failed:", e); }
};

// ---------- Helper: format price ----------
const formatPrice = (price) => {
  if(!price && price !== 0) return "Â£0";
  return "Â£" + Number(price).toLocaleString();
};

// ---------- Custom alert ----------
function showPopup(message) {
  const popup = document.createElement("div");
  popup.textContent = message;
  popup.style.position = "fixed";
  popup.style.top = "20px";
  popup.style.right = "20px";
  popup.style.padding = "10px 20px";
  popup.style.backgroundColor = "#FFD700";
  popup.style.color = "#1e1e1e";
  popup.style.fontWeight = "bold";
  popup.style.border = "2px solid #1e1e1e";
  popup.style.borderRadius = "8px";
  popup.style.zIndex = "9999";
  popup.style.transition = "all 0.3s ease";
  document.body.appendChild(popup);
  setTimeout(() => {
    popup.style.opacity = "0";
    popup.style.transform = "scale(0.9)";
    setTimeout(() => popup.remove(), 300);
  }, 2000);
}

// ---------- Popup for item details ----------
function showItemPopup(listing) {
  const overlay = document.createElement("div");
  overlay.style.position = "fixed";
  overlay.style.top = 0;
  overlay.style.left = 0;
  overlay.style.width = "100%";
  overlay.style.height = "100%";
  overlay.style.backgroundColor = "rgba(0,0,0,0.7)";
  overlay.style.display = "flex";
  overlay.style.justifyContent = "center";
  overlay.style.alignItems = "center";
  overlay.style.zIndex = "10000";

  const box = document.createElement("div");
  box.style.backgroundColor = "#2a2a2a";
  box.style.padding = "20px";
  box.style.border = "2px solid #FFD700";
  box.style.borderRadius = "8px";
  box.style.maxWidth = "400px";
  box.style.textAlign = "center";
  box.style.position = "relative";

  const closeBtn = document.createElement("span");
  closeBtn.textContent = "âœ–";
  closeBtn.style.position = "absolute";
  closeBtn.style.top = "10px";
  closeBtn.style.right = "10px";
  closeBtn.style.cursor = "pointer";
  closeBtn.style.fontSize = "20px";
  closeBtn.onclick = () => document.body.removeChild(overlay);

  const title = document.createElement("h3");
  title.textContent = listing.name;

  const desc = document.createElement("p");
  desc.textContent = listing.description || "No description available";

  const img = document.createElement("img");
  img.src = listing.image || "";
  img.style.maxWidth = "100%";
  img.style.borderRadius = "4px";
  img.style.marginTop = "10px";

  box.appendChild(closeBtn);
  box.appendChild(title);
  box.appendChild(desc);
  box.appendChild(img);

  overlay.appendChild(box);
  document.body.appendChild(overlay);
}

// ---------- Auth & Dashboard ----------
onAuthStateChanged(auth, async (user) => {
  if (!user) return window.location.href = "create_account.html";

  userStatus.textContent = `Logged in as ${user.email}`;
  logoutButton.style.display = "inline-block";

  const docRef = doc(db, "users", user.uid);

  // ---------- Load profile info ----------
  onSnapshot(docRef, (docSnap) => {
    if(docSnap.exists()){
      const data = docSnap.data();
      document.getElementById("first-name-input").value = data.firstName || "";
      document.getElementById("last-name-input").value = data.lastName || "";
      document.getElementById("email-input").value = data.email || "";
      document.getElementById("contact-input").value = data.contact || "";
      document.getElementById("address1-input").value = data.address1 || "";
      document.getElementById("address2-input").value = data.address2 || "";
      document.getElementById("city-input").value = data.city || "";
      document.getElementById("postcode-input").value = data.postcode || "";
      welcomeName.textContent = data.firstName || "User";
      if(data.profilepicurl) profilePicEl.src = data.profilepicurl;
    }
  });

  // ---------- Enable editing ----------
  editBtn.addEventListener("click", () => {
    inputs.forEach(i => i.removeAttribute("readonly"));
    profileUpload.style.display = "block";
    editBtn.style.display = "none";
    saveBtn.style.display = "inline-block";
  });

  // ---------- Save changes ----------
  saveBtn.addEventListener("click", async () => {
    let profilepicurl = profilePicEl.src;

    if(profileUpload.files.length > 0){
      const file = profileUpload.files[0];
      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", "Profile_pictures"); 
      formData.append("folder", "profilePics");

      const cloudName = "def0sfrxq";
      const url = `https://api.cloudinary.com/v1_1/${cloudName}/image/upload`;
      const res = await fetch(url, { method: "POST", body: formData });
      const data = await res.json();
      profilepicurl = data.secure_url;
      profilePicEl.src = profilepicurl;
    }

    await updateDoc(docRef, {
      firstName: document.getElementById("first-name-input").value.trim(),
      lastName: document.getElementById("last-name-input").value.trim(),
      email: document.getElementById("email-input").value.trim(),
      contact: document.getElementById("contact-input").value.trim(),
      address1: document.getElementById("address1-input").value.trim(),
      address2: document.getElementById("address2-input").value.trim(),
      city: document.getElementById("city-input").value.trim(),
      postcode: document.getElementById("postcode-input").value.trim(),
      profilepicurl
    });

    inputs.forEach(i => i.setAttribute("readonly",""));
    profileUpload.style.display = "none";
    editBtn.style.display = "inline-block";
    saveBtn.style.display = "none";

    welcomeName.textContent = document.getElementById("first-name-input").value.trim() || "User";
    showPopup("Profile updated!");
  });

  // ---------- Profile picture preview ----------
  profileUpload.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if(file) profilePicEl.src = URL.createObjectURL(file);
  });

  // ---------- Live Bids with Transactions ----------
  let allLiveBids = [];
  let livePage = 1;
  const bidsPerPage = 10;

  async function placeBidTransaction(listingid, bidInputEl, userBidSpan) {
    const bidAmount = Number(bidInputEl.value);
    if (!bidAmount || isNaN(bidAmount)) return showPopup("Invalid bid amount!");

    const listingRef = doc(db, "listings", listingid);

    try {
      await runTransaction(db, async (transaction) => {
        const listingSnap = await transaction.get(listingRef);
        if (!listingSnap.exists()) throw "Listing does not exist!";
        const currentPrice = listingSnap.data().price || 0;
        if (bidAmount <= currentPrice) throw `Bid must be higher than ${formatPrice(currentPrice)}`;
        transaction.update(listingRef, { price: bidAmount });
        const bidRef = doc(collection(db, "bids"));
        transaction.set(bidRef, {
          bidamount: bidAmount,
          listingid,
          timestamp: serverTimestamp(),
          useremail: user.email,
          userid: user.uid
        });
      });
      bidInputEl.value = "";
      userBidSpan.textContent = `Your Bid: ${formatPrice(bidAmount)}`;
      showPopup("Bid placed successfully!");
    } catch(e) {
      showPopup(e);
    }
  }

  function renderLiveBidsPage(page) {
    if (!liveBidsContainer) return;
    liveBidsContainer.innerHTML = "<h2>Live Bids</h2>";
    if (!allLiveBids.length) {
      liveBidsContainer.innerHTML += "<p>No live bids yet.</p>";
      return;
    }
    const start = (page - 1) * bidsPerPage;
    const end = start + bidsPerPage;
    const pageBids = allLiveBids.slice(start, end);

    pageBids.forEach(async b => {
      const bidEl = document.createElement("div");
      bidEl.className = "bid-card";

      const listingDoc = await getDoc(doc(db, "listings", b.listingid));
      const listingData = listingDoc.exists() ? listingDoc.data() : {};
      const auctionEndTime = listingData?.auctionend?.toDate() || null;

      const userBidSpan = document.createElement("span");
      userBidSpan.className = "user-bid";
      userBidSpan.textContent = "";

      const winningSpan = document.createElement("span");
      winningSpan.style.color = "#00FF00";
      winningSpan.style.fontWeight = "bold";
      winningSpan.textContent = "";

      const outbidSpan = document.createElement("span");
      outbidSpan.style.color = "red";
      outbidSpan.style.fontWeight = "bold";
      outbidSpan.style.display = "none";
      outbidSpan.textContent = "Outbid";

      const livePriceSpan = document.createElement("span");
      livePriceSpan.textContent = formatPrice(b.livePrice);

      const nameLink = document.createElement("a");
      nameLink.href = "#";
      nameLink.textContent = b.itemName;

      // ---------- Kollect100 badge ----------
      if(listingData.kollect100) nameLink.innerHTML += ' <span style="color:#FFD700;font-weight:bold;">[Kollect100]</span>';

      nameLink.onclick = (e) => { e.preventDefault(); showItemPopup(listingData); };

      bidEl.innerHTML = `<p><strong></strong><br>Live Price: </p>`;
      const pTag = bidEl.querySelector("p");
      pTag.querySelector("strong").appendChild(nameLink);
      pTag.appendChild(livePriceSpan);
      pTag.appendChild(document.createElement("br"));
      pTag.appendChild(userBidSpan);
      pTag.appendChild(document.createElement("br"));
      pTag.appendChild(winningSpan);
      pTag.appendChild(document.createElement("br"));
      pTag.appendChild(outbidSpan);

      const countdownEl = document.createElement("span");
      countdownEl.className = "countdown-timer";
      countdownEl.textContent = "Loading timerâ€¦";
      pTag.appendChild(document.createElement("br"));
      pTag.appendChild(countdownEl);

      if(auctionEndTime){
        const interval = setInterval(() => {
          const now = new Date();
          let diff = auctionEndTime - now;
          if(diff <= 0){
            countdownEl.textContent = "Auction ended";
            clearInterval(interval);
          } else {
            const hours = Math.floor(diff/1000/60/60);
            const minutes = Math.floor((diff/1000/60)%60);
            const seconds = Math.floor((diff/1000)%60);
            countdownEl.textContent = `Ends in ${hours}h ${minutes}m ${seconds}s`;

            // ---------- Notification: 5 minutes remaining ----------
            if(diff <= 5*60*1000 && !notificationState.auctionEndingSoon[b.listingid]){
              addNotification("Ending Soon", b.listingid, b.itemName);
            }
          }
        }, 1000);
      }

      const bidContainer = document.createElement("div");
      bidContainer.style.display = "flex";
      bidContainer.style.gap = "8px";

      const bidInput = document.createElement("input");
      bidInput.type = "number";
      bidInput.min = b.livePrice + 1;
      bidInput.placeholder = "Your bid";
      bidInput.style.flex = "1";
      bidInput.style.backgroundColor = "#1e1e1e";
      bidInput.style.color = "#fff";
      bidInput.style.border = "2px solid #FFD700";
      bidInput.style.borderRadius = "4px";
      bidInput.style.padding = "6px";

      const bidBtn = document.createElement("button");
      bidBtn.className = "consign-btn";
      bidBtn.textContent = "Place Bid";
      bidBtn.onclick = () => placeBidTransaction(b.listingid, bidInput, userBidSpan);

      bidContainer.appendChild(bidInput);
      bidContainer.appendChild(bidBtn);
      bidEl.appendChild(bidContainer);

      // ---------- Live second-by-second price listener ----------
      const listingRefLive = doc(db, "listings", b.listingid);
      onSnapshot(listingRefLive, snap => {
        if(snap.exists()){
          const latestPrice = snap.data().price || 0;
          livePriceSpan.textContent = formatPrice(latestPrice);
          bidInput.min = latestPrice + 1;
        }
      });

      // Real-time updates for this user's bid & winning message
      const bidsQuery = query(collection(db, "bids"), where("listingid","==",b.listingid));
      onSnapshot(bidsQuery, snapshot => {
        let highestBid = 0;
        let userHighest = 0;
        snapshot.forEach(doc => {
          const data = doc.data();
          if(data.bidamount > highestBid) highestBid = data.bidamount;
          if(data.userid === user.uid && data.bidamount > userHighest) userHighest = data.bidamount;
        });
        if(userHighest > 0) userBidSpan.textContent = `Your Bid: ${formatPrice(userHighest)}`;
        const winning = userHighest >= highestBid;
        winningSpan.textContent = winning ? "You're currently winning!" : "";
        outbidSpan.style.display = !winning && userHighest>0 ? "inline-block" : "none";

        // ---------- Notification: Outbid ----------
        if(userHighest > 0 && userHighest < highestBid){
          if(!notificationState.outbid[b.listingid]){
            addNotification("Outbid", b.listingid, b.itemName);
          }
        } else {
          notificationState.outbid[b.listingid] = false;
          saveNotificationState();
        }
      });

      liveBidsContainer.appendChild(bidEl);
    });
    renderLivePagination();
  }

  // ... rest of your won bids, purchase history, profile, etc., remain the same

  updateNotifDropdown();
  updateNotifCount();
});
</script>

<style>
/* === same styles as your original file === */
.container input {
  background-color: #1e1e1e;
  border: 2px solid #FFD700;
  color: #fff;
  padding: 8px;
  border-radius: 4px;
  width: 100%;
  margin: 5px 0;
  list-style: none;
}

.container ul {
  padding-left: 0;
  list-style: none;
}

.dashboard-cards {
  display: flex;
  flex-wrap: wrap;
  gap: 15px;
  margin-top: 20px;
}

.dashboard-cards .card {
  flex: 1 1 300px;
  min-width: 280px;
}

#bids-container, #purchase-history-container {
  padding:15px;
  background:#1e1e1e;
  border:2px solid #FFD700;
  border-radius:5px;
}

.bid-card {
  background:#2a2a2a;
  border:1px solid #FFD700;
  padding:8px;
  margin-bottom:5px;
  border-radius:4px;
}

.bid-card a {
  color:#FFD700;
  text-decoration:none;
  display:block;
}

.bid-card a:hover {
  text-decoration:underline;
}

#welcome-name {
  font-weight: normal;
  color: inherit;
  font-size: inherit;
}

#logout-button {
  background-color: #FFD700;
  color: #1e1e1e;
  font-weight: bold;
  border: 2px solid #1e1e1e;
  border-radius: 8px;
  padding: 8px 16px;
  cursor: pointer;
  transition: all 0.3s ease;
}

#logout-button:hover {
  background-color: #fff;
  color: #FFD700;
  border: 2px solid #FFD700;
  transform: scale(1.05);
}

.consign-btn {
  display: inline-block;
  background-color: #FFD700;
  color: #1e1e1e;
  font-weight: bold;
  text-decoration: none;
  padding: 10px 20px;
  border-radius: 8px;
  border: 2px solid #1e1e1e;
  transition: all 0.3s ease;
}

.consign-btn:hover {
  background-color: #fff;
  color: #FFD700;
  border: 2px solid #FFD700;
  transform: scale(1.05);
}

@media (max-width: 768px) {
  .dashboard-cards {
    flex-direction: column;
  }
}
</style>
</head>
<body>

<div class="burger" onclick="toggleMenu()">
  <div></div><div></div><div></div>
</div>

<nav class="nav-menu" id="navMenu">
  <a href="index.html">Home</a>
  <a href="dashboard.html">Dashboard</a>
  <a href="chat.html">Kollect Chat</a>
  <a href="live_auctions.html">Live Auctions</a>
  <a href="kollect_100.html">Kollect 100</a>
  <a href="private_sales.html">Private Sales</a>
  <a href="contact.html">Contact Us</a>
  <a href="admin.html">Admin</a>
  <a href="results.html">Results</a>
</nav>

<div id="user-status">Checking login status...</div>
<button id="logout-button" style="display:none;" onclick="logoutUser()">Logout</button>

<div class="container">
  <h1>Welcome, <span id="welcome-name">User</span></h1>

  <div style="margin: 15px 0; display: flex; gap: 15px; justify-content: center;">
    <a href="contact.html" class="consign-btn">Consign an Item</a>
    <a href="chat.html" class="consign-btn">Kollect Chat</a>
  </div>

  <div class="card">
    <h2>Your Profile</h2>
    <img id="profile-pic" src="default-profile.png" alt="Profile Picture" style="width:120px; height:120px; border-radius:50%; display:block; margin:0 auto 10px;">
    <input type="file" id="profile-upload" accept="image/*" style="display:none; margin-bottom:15px;">
    <ul>
      <li>First Name: <input id="first-name-input" readonly placeholder="First Name" /></li>
      <li>Last Name: <input id="last-name-input" readonly placeholder="Last Name" /></li>
      <li>Email: <input id="email-input" readonly placeholder="Email" /></li>
      <li>Contact: <input id="contact-input" readonly placeholder="Phone Number" /></li>
      <li>Address 1: <input id="address1-input" readonly placeholder="Address Line 1" /></li>
      <li>Address 2: <input id="address2-input" readonly placeholder="Address Line 2" /></li>
      <li>City: <input id="city-input" readonly placeholder="City" /></li>
      <li>Postcode: <input id="postcode-input" readonly placeholder="Postcode" /></li>
    </ul>
    <div style="margin-top:10px;">
      <button id="edit-btn" class="consign-btn">Edit Profile</button>
      <button id="save-btn" class="consign-btn" style="display:none;">Save Profile</button>
    </div>
  </div>

  <div class="dashboard-cards">
    <div id="live-bids-container" class="card">
      <h2>Live Bids</h2>
      <p>Loading your live bidsâ€¦</p>
    </div>

    <div id="won-bids-container" class="card">
      <h2>Won Bids</h2>
      <p>Loading your won bidsâ€¦</p>
    </div>

    <div id="purchase-history-container" class="card">
      <h2>Purchase History</h2>
      <p>Loading your purchase historyâ€¦</p>
    </div>
  </div>
</div>

<script src="/js/notification.js"></script>
  
</body>
</html>
