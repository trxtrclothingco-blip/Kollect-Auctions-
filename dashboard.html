<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard – Kollect Auctions</title>
<link rel="stylesheet" href="style.css">
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, doc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";
import { firebaseConfig } from "./firebase.js";

// ---------- Firebase Initialization ----------
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

// ---------- Elements ----------
const userStatus = document.getElementById("user-status");
const logoutButton = document.getElementById("logout-button");
const body = document.body;

// ---------- Burger Menu & Light/Dark Mode ----------
window.toggleMenu = () => document.getElementById("navMenu")?.classList.toggle("open");
if(localStorage.getItem("lightMode") === "true") body.classList.add("light-mode");
window.toggleMode = () => {
  const isLight = body.classList.toggle("light-mode");
  localStorage.setItem("lightMode", isLight);
};

// ---------- Logout ----------
window.logoutUser = async () => {
  try { 
    await signOut(auth); 
    window.location.href = "create_account.html";
  } catch(e) { console.error("Logout failed:", e); }
};

// ---------- Auth check & live dashboard update ----------
onAuthStateChanged(auth, (user) => {
  if (!user) return window.location.href = "create_account.html";

  userStatus.textContent = `Logged in as ${user.email}`;
  logoutButton.style.display = "inline-block";

  const docRef = doc(db, "users", user.uid);
  const profilePicEl = document.getElementById("profile-pic");

  // Load user info live
  onSnapshot(docRef, (docSnap) => {
    if(docSnap.exists()){
      const data = docSnap.data();
      document.getElementById("first-name").value = data.firstName || "";
      document.getElementById("last-name").value = data.lastName || "";
      document.getElementById("user-email").textContent = data.email || "";
      document.getElementById("contact").value = data.contact || "";
      document.getElementById("address1").value = data.address1 || "";
      document.getElementById("address2").value = data.address2 || "";
      document.getElementById("city").value = data.city || "";
      document.getElementById("postcode").value = data.postcode || "";
      if(data.profilePicUrl) profilePicEl.src = data.profilePicUrl;
    }
  });

  // Save changes button
  document.getElementById("save-btn").addEventListener("click", async () => {
    const updatedData = {
      firstName: document.getElementById("first-name").value,
      lastName: document.getElementById("last-name").value,
      contact: document.getElementById("contact").value,
      address1: document.getElementById("address1").value,
      address2: document.getElementById("address2").value,
      city: document.getElementById("city").value,
      postcode: document.getElementById("postcode").value
    };
    await updateDoc(docRef, updatedData);
    alert("Profile updated!");
  });

  // Profile picture upload
  document.getElementById("profile-upload").addEventListener("change", async (e) => {
    const file = e.target.files[0];
    if(!file) return;
    const storageRef = ref(storage, `profilePics/${user.uid}`);
    await uploadBytes(storageRef, file);
    const url = await getDownloadURL(storageRef);
    await updateDoc(docRef, { profilePicUrl: url });
    profilePicEl.src = url;
    alert("Profile picture updated!");
  });
});
</script>
</head>
<body>

<!-- Burger Menu -->
<div class="burger" onclick="toggleMenu()">
  <div></div><div></div><div></div>
</div>

<nav class="nav-menu" id="navMenu">
  <a href="index.html">Home</a>
  <a href="dashboard.html">Dashboard</a>
  <a href="live_auctions.html">Live Auctions</a>
  <a href="kollect_100.html">Kollect 100</a>
  <a href="private_sales.html">Private Sales</a>
  <a href="contact.html">Contact Us</a>
  <a href="admin.html">Admin</a>
  <a href="results.html">Results</a>
  <button id="modeToggle" onclick="toggleMode()">Toggle Light/Dark Mode</button>
</nav>

<!-- User Status -->
<div id="user-status">Checking login status...</div>
<button id="logout-button" style="display:none;" onclick="logoutUser()">Logout</button>

<!-- Dashboard Content -->
<div class="container">
  <h1>Welcome, <input id="first-name" placeholder="First Name" /></h1>
  
  <div class="card">
    <h2>Your Account Info</h2>
    <img id="profile-pic" src="default-profile.png" alt="Profile Picture" style="width:120px; height:120px; border-radius:50%; display:block; margin:0 auto 15px;">
    <input type="file" id="profile-upload" accept="image/*">

    <ul>
      <li>First Name: <input id="first-name" placeholder="First Name" /></li>
      <li>Last Name: <input id="last-name" placeholder="Last Name" /></li>
      <li>Email: <span id="user-email">—</span></li>
      <li>Contact: <input id="contact" placeholder="Phone Number" /></li>
      <li>Address 1: <input id="address1" placeholder="Address Line 1" /></li>
      <li>Address 2: <input id="address2" placeholder="Address Line 2" /></li>
      <li>City: <input id="city" placeholder="City" /></li>
      <li>Postcode: <input id="postcode" placeholder="Postcode" /></li>
    </ul>
    <button class="button" id="save-btn">Save Changes</button>
  </div>
</div>

</body>
</html>
