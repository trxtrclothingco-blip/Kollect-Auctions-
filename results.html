<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Auction Results – Kollect</title>
<link rel="stylesheet" href="style.css">
<script type="module" src="firebase.js"></script>
</head>
<body>

<div class="burger" onclick="toggleMenu()">
  <div></div><div></div><div></div>
</div>

<nav class="nav-menu" id="navMenu">
  <a href="index.html">Home</a>
  <a href="dashboard.html">Dashboard</a>
  <a href="about.html">About Us</a>
  <a href="live_auctions.html">Live Auctions</a>
  <a href="kollect_100.html">Kollect 100</a>
  <a href="private_sales.html">Private Sales</a>
  <a href="contact.html">Contact Us</a>
  <a href="admin.html">Admin</a>
  <a href="results.html">Results</a>
  <a href="create_account.html">Sign In</a>
  <button id="modeToggle" onclick="toggleMode()">Toggle Light/Dark Mode</button>
</nav>

<div id="user-status">Checking login status...</div>
<button id="logout-button" style="display:none;" onclick="logoutUser()">Logout</button>

<div class="container">
  <img src="IMG_1604.jpeg" alt="Kollect Auctions Logo" class="hero-image">
  <h1>Past Auction Results</h1>

  <!-- Ended Auctions Section -->
  <div id="ended-auctions-list" style="max-height:650px; overflow-y:auto; padding-right:10px;">
    <!-- auctions injected here by results.js -->
  </div>
  <div id="auction-pagination-controls" style="margin-top:10px;"></div>

  <button class="button" onclick="window.location='index.html'">Back to Home</button>
</div>

<!-- Results JS -->
<script type="module">
import { db } from "./firebase.js";
import { collection, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

// ---------- Pagination Settings ----------
let auctionsAll = [];
let auctionsPage = 1;
const auctionsPerPage = 3; // show 3 per page

function renderAuctionsPage(page) {
  const container = document.getElementById("ended-auctions-list");
  container.innerHTML = "";

  const start = (page - 1) * auctionsPerPage;
  const end = start + auctionsPerPage;
  const pageAuctions = auctionsAll.slice(start, end);

  pageAuctions.forEach((a, index) => {
    container.innerHTML += `
      <div class="ended-auction bid-item" data-index="${start + index}" style="margin-bottom:20px;">
        <p><strong>${a.name}</strong></p>
        ${a.image ? `<img src="${a.image}" style="width:100%;max-width:200px;">` : ""}
        <p>Final Price: £${(a.winningbid || a.price).toLocaleString()}</p>
        <p>Winner: ${a.winneremail || "No bids"}</p>
        <p>Ended At: ${a.auctionend.toLocaleString()}</p>
        <hr>
      </div>
    `;
  });

  renderAuctionPagination();
}

function renderAuctionPagination() {
  const controls = document.getElementById("auction-pagination-controls");
  controls.innerHTML = "";

  const totalPages = Math.ceil(auctionsAll.length / auctionsPerPage);

  if (auctionsPage > 1) {
    const prevBtn = document.createElement("button");
    prevBtn.textContent = "Previous";
    prevBtn.onclick = () => { auctionsPage--; renderAuctionsPage(auctionsPage); };
    controls.appendChild(prevBtn);
  }

  if (auctionsPage < totalPages) {
    const nextBtn = document.createElement("button");
    nextBtn.textContent = "Next";
    nextBtn.onclick = () => { auctionsPage++; renderAuctionsPage(auctionsPage); };
    controls.appendChild(nextBtn);
  }
}

// ---------- Load Ended Auctions ----------
function loadEndedAuctions() {
  const q = query(collection(db, "listings"), orderBy("auctionend", "asc"));
  onSnapshot(q, snapshot => {
    auctionsAll = [];

    snapshot.forEach(docSnap => {
      const d = docSnap.data();
      if (d.pricetype !== "auction") return; // only auctions
      if (!d.winningbid) return; // only ended auctions

      auctionsAll.push({
        ...d,
        auctionend: d.auctionend?.toDate(),
        winningbid: d.winningbid || d.price,
        winneremail: d.winneremail || "No bids"
      });
    });

    auctionsAll.sort((a, b) => a.auctionend - b.auctionend);
    auctionsPage = 1;
    renderAuctionsPage(auctionsPage);
  });
}

loadEndedAuctions();
</script>

</body>
</html>
